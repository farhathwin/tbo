{% extends 'base.html' %}
{% block title %}Customer View{% endblock %}

{% block content %}
<h3>Customer Details</h3>

<ul class="nav nav-tabs" id="custTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">Details</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tx-tab" data-bs-toggle="tab" data-bs-target="#tx" type="button" role="tab">Transactions</button>
  </li>
</ul>

<div class="tab-content mt-3">
  <div class="tab-pane fade show active" id="detail" role="tabpanel">
    <div class="card mb-3">
      <div class="card-body">
        <p><strong>Type:</strong> {{ customer.customer_type }}</p>
        <p><strong>Full Name:</strong> {{ customer.full_name or '-' }}</p>
        <p><strong>Business Name:</strong> {{ customer.business_name or '-' }}</p>
        <p><strong>Phone:</strong> {{ customer.phone_number }}</p>
        <p><strong>Status:</strong>
          {% if customer.is_active %}
            <span class="badge bg-success">Active</span>
          {% else %}
            <span class="badge bg-secondary">Disabled</span>
          {% endif %}
        </p>
        <p><strong>Current Balance:</strong> {{ "{:,.2f}".format(balance or 0) }}</p>
        <p><strong>Unallocated Deposit:</strong> {{ "{:,.2f}".format(deposit_balance or 0) }}</p>
        <a href="{{ url_for('accounting_routes.toggle_customer_status', customer_id=customer.id) }}"
           class="btn btn-sm {{ 'btn-danger' if customer.is_active else 'btn-success' }}">
          {{ 'Disable' if customer.is_active else 'Enable' }}
        </a>
      </div>
    </div>

    <!-- Opening Balance Form -->
    <h5>Opening Balance</h5>
    <form method="POST" action="{{ url_for('accounting_routes.add_opening_balance', customer_id=customer.id) }}">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label>Opening Balance Amount</label>
          <input type="number" step="0.01" name="opening_balance" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label>Date</label>
          <input type="date" name="date" class="form-control" required value="{{ current_date }}">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-success">ðŸ’¾ Save Opening Balance</button>
        </div>
      </div>
    </form>
  </div>

  <div class="tab-pane fade" id="tx" role="tabpanel">
    <h5>Transactions</h5>
    <table class="table table-bordered table-sm">
      <thead>
        <tr>
          <th>Date</th>
          <th>Reference</th>
          <th>Account</th>
          <th>Debit</th>
          <th>Credit</th>
          <th>Narration</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
        <tr>
          <td>{{ t.entry.date.strftime('%Y-%m-%d') }}</td>
          <td>{{ t.entry.reference }}</td>
          <td>{{ t.account.account_code }} - {{ t.account.account_name }}</td>
          <td>{{ "{:,.2f}".format(t.debit or 0) }}</td>
          <td>{{ "{:,.2f}".format(t.credit or 0) }}</td>
          <td>{{ t.narration }}</td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="text-center text-muted">No transactions.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<a href="{{ url_for('accounting_routes.customer_list') }}" class="btn btn-secondary mt-4">â¬… Back to List</a>
{% endblock %}
