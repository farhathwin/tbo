{% extends 'base.html' %}
{% block title %}Edit Invoice{% endblock %}
{% block content %}
<h3>Edit Invoice #{{ invoice.invoice_number }}</h3>
<div class="mb-3">
  <p><strong>Customer:</strong> {{ invoice.customer.full_name or invoice.customer.business_name }}</p>
  <p><strong>Service Type:</strong> {{ invoice.service_type }}</p>
  <p><strong>Date:</strong> {{ invoice.invoice_date.strftime('%Y-%m-%d') }}</p>
  <p><strong>Status:</strong> <span class="badge bg-info">{{ invoice.status }}</span></p>
  <p><strong>Total:</strong> {{ "{:,.2f}".format(invoice.total_amount) }}</p>
</div>
<hr>

<h5>ðŸ‘¤ Pax Details</h5>
<form method="POST" action="{{ url_for('accounting_routes.add_pax_detail', invoice_id=invoice.id) }}">
  <div class="row g-2">
    <div class="col-md-2">
      <label>Pax Type</label>
      <select name="pax_type" class="form-select">
        <option value="ADT">Adult</option>
        <option value="CHD">Child</option>
        <option value="INF">Infant</option>
      </select>
    </div>
    <div class="col-md-2">
      <label>Last Name</label>
      <input type="text" name="last_name" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label>First Name</label>
      <input type="text" name="first_name" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label>Date of Birth</label>
      <input type="date" name="dob" class="form-control">
    </div>
    <div class="col-md-2">
      <label>Passport No</label>
      <input type="text" name="passport_no" class="form-control">
    </div>
    <div class="col-md-2">
      <label>Nationality</label>
      <input type="text" name="nationality" class="form-control">
    </div>
    <div class="col-md-2">
      <label>Passport Expiry</label>
      <input type="date" name="passport_expiry_date" class="form-control">
    </div>
    <div class="col-md-1">
      <label>&nbsp;</label>
      <button type="submit" class="btn btn-success w-100">âž•</button>
    </div>
  </div>
</form>

{% if invoice.pax_details %}
<div class="mt-3">
  <table class="table table-sm table-bordered">
    <thead>
      <tr>
        <th>Type</th>
        <th>Last Name</th>
        <th>First Name</th>
        <th>DOB</th>
        <th>Passport</th>
        <th>Nationality</th>
        <th>Passport Expiry</th>
      </tr>
    </thead>
    <tbody>
      {% for pax in invoice.pax_details %}
      <tr>
        <td>{{ pax.pax_type }}</td>
        <td>{{ pax.last_name }}</td>
        <td>{{ pax.first_name }}</td>
        <td>{{ pax.date_of_birth.strftime('%Y-%m-%d') if pax.date_of_birth }}</td>
        <td>{{ pax.passport_no }}</td>
        <td>{{ pax.nationality }}</td>
        <td>{{ pax.passport_expiry_date.strftime('%Y-%m-%d') if pax.passport_expiry_date }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<hr>
<h5>âž• Add Line Item</h5>
<form method="POST" action="{{ url_for('accounting_routes.add_invoice_line', invoice_id=invoice.id) }}">
  <div class="row g-2 mb-2">
    <div class="col-md-2">
      <label>Type</label>
      <select name="type" id="type" class="form-select" required onchange="toggleTypeFields()">
        <option value="">-- Select --</option>
        <option value="Air Ticket">Air Ticket</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="col-md-2">
      <label>Sub Type</label>
      <select name="sub_type" id="sub_type" class="form-select" required onchange="toggleSubTypeFields()"></select>
    </div>
    <div class="col-md-2 pax-box d-none">
      <label>Passenger</label>
      <select name="pax_id" class="form-select">
        <option value="">-- Select Pax --</option>
        {% for pax in invoice.pax_details %}
        <option value="{{ pax.id }}">{{ pax.first_name }} {{ pax.last_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label>Base Fare</label>
      <input type="number" name="base_fare" id="base_fare" step="0.01" class="form-control" oninput="calcProfit()">
    </div>
    <div class="col-md-2 tax-box d-none">
      <label>Tax</label>
      <input type="number" name="tax" id="tax" step="0.01" class="form-control" oninput="calcProfit()">
    </div>
    <div class="col-md-2">
      <label>Sell Price</label>
      <input type="number" name="sell_price" id="sell_price" step="0.01" class="form-control" oninput="calcProfit()">
    </div>
    <div class="col-md-2">
      <label>Profit</label>
      <input type="text" name="profit" id="profit" class="form-control" readonly>
    </div>
    <div class="col-md-2">
      <label id="pnrLabel">PNR / Ref</label>
      <input type="text" name="pnr" class="form-control">
    </div>
    <div class="col-md-2 iata-only-field d-none">
      <label>Designator</label>
      <input type="text" name="designator" class="form-control">
    </div>
    <div class="col-md-3 iata-only-field d-none">
      <label>Ticket No</label>
      <input type="text" name="ticket_no" class="form-control" maxlength="18" pattern="\d{10,16}(-\d{1,2})?" title="10-16 digits, optionally followed by - and up to two digits">
    </div>
    <div class="col-md-3">
      <label>Supplier</label>
      <select name="supplier_id" class="form-select">
        <option value="">-- None --</option>
        {% for s in suppliers %}
        <option value="{{ s.id }}">{{ s.business_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-1">
      <label>&nbsp;</label>
      <button type="submit" class="btn btn-success w-100">Add</button>
    </div>
  </div>
</form>

<hr>
<h5>ðŸ“¦ Invoice Items</h5>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>Passenger</th>
      <th>Type</th>
      <th>Sub Type</th>
      <th>Base Fare</th>
      <th>Tax</th>
      <th>Sell</th>
      <th>Profit</th>
      <th>PNR / Ref</th>
      <th>Ticket No</th>
      <th>Supplier</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for line in invoice.lines %}
    <tr>
      <td>{{ (line.pax.first_name ~ ' ' ~ line.pax.last_name) if line.pax else '-' }}</td>
      <td>{{ line.type }}</td>
      <td>{{ line.sub_type }}</td>
      <td>{{ "{:,.2f}".format(line.base_fare or 0) }}</td>
      <td>{{ "{:,.2f}".format(line.tax or 0) }}</td>
      <td>{{ "{:,.2f}".format(line.sell_price) }}</td>
      <td>{{ "{:,.2f}".format(line.profit or 0) }}</td>
      <td>{{ line.pnr }}</td>
      <td>{{ line.designator }}{{ line.ticket_no }}</td>
      <td>{{ line.supplier.business_name if line.supplier else '-' }}</td>
      <td>
        <a href="{{ url_for('accounting_routes.edit_invoice_line', line_id=line.id) }}" class="btn btn-sm btn-primary">Edit</a>
        <a href="{{ url_for('accounting_routes.delete_invoice_line', line_id=line.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this line item?')">Delete</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<form method="POST" action="{{ url_for('accounting_routes.save_invoice', invoice_id=invoice.id) }}">
  <button type="submit" class="btn btn-primary">ðŸ’¾ Save</button>
</form>
<a href="{{ url_for('accounting_routes.invoice_list') }}" class="btn btn-secondary mt-3">â¬… Back to Invoice List</a>

<script>
function calcProfit() {
  const base = parseFloat(document.getElementById("base_fare").value) || 0;
  const tax = parseFloat(document.getElementById("tax").value) || 0;
  const sell = parseFloat(document.getElementById("sell_price").value) || 0;
  const type = document.getElementById("type").value;
  let profit = 0;
  if (type === "Air Ticket") {
    profit = sell - (base + tax);
  } else {
    profit = sell - base;
  }
  document.getElementById("profit").value = profit.toFixed(2);
}

function toggleTypeFields() {
  const type = document.getElementById("type").value;
  const subTypeSelect = document.getElementById("sub_type");
  subTypeSelect.innerHTML = '<option value="">-- Select Sub Type --</option>';
  const taxBox = document.querySelector('.tax-box');
  const paxBox = document.querySelector('.pax-box');
  const pnrLabel = document.getElementById("pnrLabel");

  if (type === "Air Ticket") {
    subTypeSelect.innerHTML += '<option value="IATA">IATA Airline</option><option value="Budget">Budget Airline</option>';
    taxBox.classList.remove("d-none");
    paxBox.classList.remove("d-none");
    pnrLabel.textContent = "PNR";
  } else if (type === "Other") {
    ["Hotel","Packages","Transfer","Visa","Insurance","Other"].forEach(option => {
      subTypeSelect.innerHTML += `<option value="${option}">${option}</option>`;
    });
    taxBox.classList.add("d-none");
    paxBox.classList.add("d-none");
    pnrLabel.textContent = "Reference";
  }
  toggleSubTypeFields();
}

function toggleSubTypeFields() {
  const subType = document.getElementById("sub_type").value;
  document.querySelectorAll('.iata-only-field').forEach(field => field.classList.add('d-none'));
  if (subType === "IATA") {
    document.querySelectorAll('.iata-only-field').forEach(field => field.classList.remove('d-none'));
  }
}

document.addEventListener("DOMContentLoaded", () => {
  toggleTypeFields();
  document.getElementById("type").addEventListener("change", toggleTypeFields);
  document.getElementById("sub_type").addEventListener("change", toggleSubTypeFields);
});
</script>
{% endblock %}
