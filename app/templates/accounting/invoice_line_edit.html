{% extends 'base.html' %}
{% block title %}Edit Invoice Line{% endblock %}
{% block content %}
<h3>Edit Line Item for Invoice #{{ line.invoice.invoice_number }}</h3>
<form method="POST">
  <div class="row g-2 mb-2">
    <div class="col-md-2">
      <label>Type</label>
      <select name="type" id="type" class="form-select" required onchange="toggleTypeFields()">
        <option value="Air Ticket" {% if line.type == 'Air Ticket' %}selected{% endif %}>Air Ticket</option>
        <option value="Other" {% if line.type == 'Other' %}selected{% endif %}>Other</option>
      </select>
    </div>
    <div class="col-md-2">
      <label>Sub Type</label>
      <select name="sub_type" id="sub_type" class="form-select" required onchange="toggleSubTypeFields()">
        <option value="">-- Select Sub Type --</option>
      </select>
    </div>
    <div class="col-md-3">
      <label>Passenger</label>
      <select name="pax_id" class="form-select">
        <option value="">-- Select Pax --</option>
        {% for pax in line.invoice.pax_details %}
        <option value="{{ pax.id }}" {% if line.pax_id == pax.id %}selected{% endif %}>{{ pax.first_name }} {{ pax.last_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label>Base Fare</label>
      <input type="number" name="base_fare" id="base_fare" step="0.01" class="form-control" value="{{ line.base_fare }}" oninput="calcProfit()">
    </div>
    <div class="col-md-2">
      <label>Tax</label>
      <input type="number" name="tax" id="tax" step="0.01" class="form-control" value="{{ line.tax }}" oninput="calcProfit()">
    </div>
    <div class="col-md-2">
      <label>Sell Price</label>
      <input type="number" name="sell_price" id="sell_price" step="0.01" class="form-control" value="{{ line.sell_price }}" oninput="calcProfit()" required>
    </div>
    <div class="col-md-2">
      <label>Profit</label>
      <input type="text" name="profit" id="profit" class="form-control" value="{{ line.profit }}" readonly>
    </div>
    <div class="col-md-2 air-ticket-field">
      <label>PNR</label>
      <input type="text" name="pnr" class="form-control" value="{{ line.pnr }}">
    </div>
    <div class="col-md-2 iata-only-field">
      <label>Designator</label>
      <input type="text" name="designator" class="form-control" value="{{ line.designator }}">
    </div>
    <div class="col-md-3 iata-only-field">
      <label>Ticket No</label>
      <input type="text" name="ticket_no" class="form-control" maxlength="18" value="{{ line.ticket_no }}" pattern="\d{10,16}(-\d{1,2})?" title="10-16 digits, optionally followed by - and up to two digits">
    </div>
    <div class="col-md-3">
      <label>Supplier</label>
      <select name="supplier_id" class="form-select">
        <option value="">-- None --</option>
        {% for s in suppliers %}
        <option value="{{ s.id }}" {% if line.supplier_id == s.id %}selected{% endif %}>{{ s.business_name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="mt-3">
    <button type="submit" class="btn btn-success">ðŸ’¾ Update Line</button>
    <a href="{{ url_for('accounting_routes.edit_invoice', invoice_id=line.invoice_id) }}" class="btn btn-secondary">â¬… Back to Invoice</a>
  </div>
</form>
{% endblock %}

<script>
function calcProfit() {
  const base = parseFloat(document.getElementById("base_fare").value) || 0;
  const tax = parseFloat(document.getElementById("tax").value) || 0;
  const sell = parseFloat(document.getElementById("sell_price").value) || 0;
  const type = document.getElementById("type").value;
  let profit = 0;
  if (type === "Air Ticket") {
    profit = sell - (base + tax);
  } else {
    profit = sell - base;
  }
  document.getElementById("profit").value = profit.toFixed(2);
}

function toggleTypeFields() {
  const type = document.getElementById("type").value;
  const subTypeSelect = document.getElementById("sub_type");
  subTypeSelect.innerHTML = '<option value="">-- Select Sub Type --</option>';
  if (type === "Air Ticket") {
    subTypeSelect.innerHTML += '<option value="IATA">IATA Airline</option><option value="Budget">Budget Airline</option>';
  } else if (type === "Other") {
    subTypeSelect.innerHTML += '<option value="Hotel">Hotel</option><option value="Packages">Packages</option><option value="Transfer">Transfer</option><option value="Visa">Visa</option><option value="Incurrence">Incurrence</option><option value="Other">Other</option>';
  }
  toggleSubTypeFields();
}

function toggleSubTypeFields() {
  const type = document.getElementById("type").value;
  const subType = document.getElementById("sub_type").value;
  document.querySelectorAll('.air-ticket-field').forEach(e => e.style.display = 'none');
  document.querySelectorAll('.iata-only-field').forEach(e => e.style.display = 'none');
  if (type === "Air Ticket") {
    document.querySelectorAll('.air-ticket-field').forEach(e => e.style.display = 'block');
    if (subType === "IATA") {
      document.querySelectorAll('.iata-only-field').forEach(e => e.style.display = 'block');
    }
  }
}

document.addEventListener("DOMContentLoaded", function() {
  toggleTypeFields();
  document.getElementById("sub_type").value = "{{ line.sub_type }}";
  toggleSubTypeFields();
  calcProfit();
});
</script>
